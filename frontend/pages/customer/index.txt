<template>
  <!-- พื้นหลังสุด เปลี่ยนสีตามตัวกรอง (โทนอ่อน / pastel) -->
  <div
    class="min-h-screen px-4 pt-4 pb-6 transition-colors duration-300"
    :class="pageBgClass"
  >
    <!-- top header / hero -->
    <section
      class="relative overflow-hidden rounded-[26px] bg-gradient-to-br from-emerald-600 via-emerald-500 to-emerald-400 px-4 pt-4 pb-[18px] text-emerald-50 shadow-sm"
    >
      <h1 class="mt-1 text-[20px] font-bold leading-snug">รายการแจ้งงาน</h1>
      <p class="mb-3 mt-0.5 text-[12px] leading-relaxed text-emerald-50/95">
        ดูสถานะงานที่ลูกค้าแจ้งทั้งหมด แตะเพื่อเปิดรายละเอียด
      </p>

      <!-- ใช้การ์ดด้านบนเป็นตัวกรอง -->
      <div class="grid grid-cols-3 gap-2">
        <!-- in_progress -->
        <button
          type="button"
          @click="selectedFilter = 'in_progress'"
          :class="[
            'flex items-center gap-1.5 rounded-2xl px-2.5 py-1.5 backdrop-blur transition active:scale-[0.98]',
            selectedFilter === 'in_progress'
              ? filterStyles.in_progress
              : 'bg-white/10 text-emerald-50/90 opacity-80',
          ]"
          class="border-2 border-white/70"
        >
          <Clock class="h-5 w-5" />
          <div>
            <p class="text-[10px] opacity-90">กำลังดำเนินการ</p>
            <p class="text-[15px] font-bold">{{ inProgressCount }}</p>
          </div>
        </button>

        <!-- done -->
        <button
          type="button"
          @click="selectedFilter = 'done'"
          :class="[
            'flex items-center gap-1.5 rounded-2xl px-2.5 py-1.5 backdrop-blur transition active:scale-[0.98]',
            selectedFilter === 'done'
              ? filterStyles.done
              : 'bg-white/10 text-emerald-50/90 opacity-80',
          ]"
          class="border-2 border-white/70"
        >
          <CheckCircle2 class="h-5 w-5" />
          <div>
            <p class="text-[10px] opacity-90">เสร็จแล้ว</p>
            <p class="text-[15px] font-bold">{{ doneCount }}</p>
          </div>
        </button>

        <!-- all -->
        <button
          type="button"
          @click="selectedFilter = 'all'"
          :class="[
            'flex items-center gap-1.5 rounded-2xl px-2.5 py-1.5 backdrop-blur transition active:scale-[0.98]',
            selectedFilter === 'all'
              ? filterStyles.all
              : 'bg-white/10 text-emerald-50/90 opacity-80',
          ]"
          class="border-2 border-white/70"
        >
          <ClipboardList class="h-5 w-5" />
          <div>
            <p class="text-[10px] opacity-90">งานทั้งหมด</p>
            <p class="text-[15px] font-bold">{{ totalTasks }}</p>
          </div>
        </button>
      </div>

      <p class="mt-2 text-[11px] text-emerald-50/80">
        กำลังแสดง {{ filteredTasks.length }} งานตามตัวกรอง
      </p>
    </section>

    <!-- search box -->
    <section class="mt-3">
      <div class="relative">
        <!-- icon ซ้าย -->
        <span
          class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3 text-emerald-500/70"
        >
          <Search class="h-4 w-4" />
        </span>

        <!-- ช่องค้นหา -->
        <input
          v-model="searchQuery"
          type="text"
          inputmode="search"
          placeholder="ค้นหาจากเลขที่งาน ห้อง หรือคำอธิบาย"
          class="w-full rounded-2xl border border-emerald-100 bg-white/90 py-2 pl-9 pr-8 text-[13px] text-gray-800 shadow-sm outline-none ring-0 placeholder:text-gray-400 focus:border-emerald-400 focus:bg-white focus:shadow-[0_10px_24px_rgba(15,23,42,0.08)] focus:ring-2 focus:ring-emerald-200"
        />

        <!-- ปุ่มล้างข้อความ -->
        <button
          v-if="searchQuery"
          type="button"
          @click="searchQuery = ''"
          class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 active:scale-95"
        >
          <X class="h-4 w-4" />
        </button>
      </div>
    </section>

    <!-- list -->
    <section class="mt-3">
      <div class="flex flex-col gap-2.5 pb-1">
        <NuxtLink
          v-for="task in filteredTasks"
          :key="task.id"
          :to="`/customer/task/${task.id}`"
          class="relative grid grid-cols-[1fr,auto] items-stretch gap-2.5 rounded-[22px] bg-white px-3.5 py-3 text-inherit shadow-[0_14px_34px_rgba(15,23,42,0.08)] no-underline transition-transform transition-shadow active:scale-[0.985] active:shadow-[0_10px_22px_rgba(15,23,42,0.16)]"
        >
          <!-- center content (เหลือแค่ส่วนนี้) -->
          <div class="flex flex-col gap-1">
            <div class="flex items-baseline justify-between gap-2">
              <p class="text-[13px] font-semibold text-gray-900">
                หมายเลข {{ task.ticket }}
              </p>
              <p class="text-[11px] text-gray-400">
                {{ formatUpdatedAt(task.updatedAt) }}
              </p>
            </div>

            <div class="mt-0.5 flex flex-wrap gap-x-3 gap-y-1.5">
              <div
                class="inline-flex items-center gap-1 text-[11px] text-gray-600"
              >
                <MapPin class="h-3.5 w-3.5" />
                <span>ห้อง {{ task.room }}</span>
              </div>

              <div
                class="inline-flex items-center gap-1 text-[11px] text-gray-600"
              >
                <CheckCircle2
                  v-if="task.status === 'done'"
                  class="h-3.5 w-3.5 text-emerald-600"
                />
                <Clock v-else class="h-3.5 w-3.5 text-amber-600" />
                <span>{{ statusShort(task.status) }}</span>
              </div>

              <!-- attachments -->
              <div
                v-if="task.hasImage || task.hasVideo"
                class="inline-flex items-center gap-1 text-[11px] text-sky-600"
              >
                <ImageIcon v-if="task.hasImage" class="h-3.5 w-3.5" />
                <Video v-if="task.hasVideo" class="h-3.5 w-3.5" />
              </div>

              <div
                v-if="(task.commentsCount ?? 0) > 0"
                class="inline-flex items-center gap-1 text-[11px] text-purple-600"
              >
                <MessageCircle class="h-3.5 w-3.5" />
                <span>{{ task.commentsCount }}</span>
              </div>

              <!-- ⭐ rating: ขึ้นเฉพาะงานที่ให้คะแนนได้ -->
              <div
                v-if="task.canRate"
                class="inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-[10px]"
                :class="
                  task.rating
                    ? 'bg-amber-50 text-amber-700'
                    : 'bg-slate-100 text-slate-500'
                "
              >
                <Star
                  class="h-3.5 w-3.5"
                  :class="
                    task.rating
                      ? 'fill-amber-400 text-amber-400'
                      : 'text-slate-400'
                  "
                />
                <!-- ถ้าให้แล้ว โชว์คะแนน เช่น 4/5, ถ้ายังไม่ให้ใช้คำสั้น ๆ -->
                <span v-if="task.rating">{{ task.rating }}/5</span>
                <span v-else>รอคะแนน</span>
              </div>
            </div>

            <p class="mt-1 text-[12px] leading-snug text-gray-600">
              {{ task.description }}
            </p>

            <!-- เส้นตาย / วันที่กำหนดแล้วเสร็จ สีแดง -->
            <p class="mt-1 text-[11px] font-semibold text-red-500">
              กำหนดแล้วเสร็จ: {{ formatDueDate(task.dueDate) }}
            </p>
          </div>

          <!-- arrow -->
          <div class="flex items-center justify-center text-gray-400">
            <ChevronRight class="h-4 w-4" />
          </div>
        </NuxtLink>

        <div
          v-if="filteredTasks.length === 0"
          class="pt-6 pb-4 flex flex-col items-center justify-center text-center text-gray-400"
        >
          <img
            src="/logo.png"
            alt="ไม่มีรายการงาน"
            class="mb-3 h-16 w-auto opacity-80"
          />
          <p class="text-[12px]">ไม่พบงานในขณะนี้</p>
        </div>
      </div>
    </section>
  </div>
</template>

<script setup lang="ts">
import {
  ClipboardList,
  ChevronRight,
  MapPin,
  Clock,
  CheckCircle2,
  Image as ImageIcon,
  Video,
  MessageCircle,
  Search,
  X,
  Star,
} from "lucide-vue-next";


type TaskStatus = "in_progress" | "done";

interface Task {
  id: string;
  ticket: string;
  room: string;
  description: string;
  status: TaskStatus;
  updatedAt: string; // ISO string เช่น "2025-11-01T10:36:05+07:00"
  dueDate: string;
  hasImage?: boolean;
  hasVideo?: boolean;
  commentsCount?: number;

  //rating
  canRate?: boolean; // ขึ้นไอคอนได้หรือยัง
  rating?: number | null; // ถ้าให้แล้ว 1–5, ถ้ายัง = null
}

const allTasks: Task[] = [
  {
    id: "TSK-0001",
    ticket: "TSK-0001",
    room: "1205",
    description: "แอร์ไม่เย็น มีเสียงดังตอนเปิดโหมดเย็น ขอช่างเช็กด่วน",
    status: "in_progress",
    updatedAt: "2025-11-13T09:24:00+07:00",
    dueDate: "2025-11-14T17:00:00+07:00",
    hasImage: true,
    hasVideo: true,
    commentsCount: 3,
    canRate: false, // ยังให้คะแนนไม่ได้
    rating: null,
  },
  {
    id: "TSK-0002",
    ticket: "TSK-0002",
    room: "803",
    description: "ไฟในห้องน้ำไม่ติด อาจเป็นที่เบรกเกอร์",
    status: "in_progress",
    updatedAt: "2025-11-13T08:10:00+07:00",
    dueDate: "2025-11-15T17:00:00+07:00",
    hasVideo: true,
    commentsCount: 1,
    canRate: false,
    rating: null,
  },
  {
    id: "TSK-0003",
    ticket: "TSK-0003",
    room: "1502",
    description: "ประตูระเบียงปิดไม่สนิท มีเสียงลมแรงตอนกลางคืน",
    status: "in_progress",
    updatedAt: "2025-11-12T15:32:00+07:00",
    dueDate: "2025-11-16T17:00:00+07:00",
    hasImage: true,
    commentsCount: 0,
    canRate: false,
    rating: null,
  },
  {
    id: "TSK-0004",
    ticket: "TSK-0004",
    room: "607",
    description: "เปลี่ยนรีโมตทีวี ลูกค้าทำตกแล้วใช้งานไม่ได้",
    status: "done",
    updatedAt: "2025-11-12T10:18:00+07:00",
    dueDate: "2025-11-12T16:00:00+07:00",
    commentsCount: 2,
    canRate: true, // งานนี้ให้คะแนนได้แล้ว
    rating: 4, // ให้แล้ว 4 ดาว
  },
  {
    id: "TSK-0005",
    ticket: "TSK-0005",
    room: "302",
    description: "ฝักบัวรั่ว น้ำกระเด็นออกนอกโซนอาบน้ำ",
    status: "in_progress",
    updatedAt: "2025-11-11T18:42:00+07:00",
    dueDate: "2025-11-17T17:00:00+07:00",
    commentsCount: 0,
    canRate: true, // ถึงเวลาให้คะแนน แต่ยังไม่ให้
    rating: null,
  },
];

type FilterKey = "all" | "in_progress" | "done";

const filterStyles: Record<FilterKey, string> = {
  all: "bg-blue-400 text-white shadow-sm ring-1 ring-white/60",
  in_progress: "bg-amber-400 text-white shadow-sm ring-1 ring-white/60",
  done: "bg-emerald-400 text-white shadow-sm ring-1 ring-white/60",
};

const selectedFilter = ref<FilterKey>("in_progress");
const searchQuery = ref("");

const filteredTasks = computed(() => {
  // ขั้นแรก: filter ตามสถานะ
  let tasks =
    selectedFilter.value === "all"
      ? allTasks
      : allTasks.filter((t) => t.status === selectedFilter.value);

  // ถ้าไม่พิมพ์อะไร ให้คืนตาม filter อย่างเดียว
  const q = searchQuery.value.trim().toLowerCase();
  if (!q) return tasks;

  // ค้นหาเลขที่งาน, ห้อง, คำอธิบาย
  return tasks.filter((t) => {
    return (
      t.ticket.toLowerCase().includes(q) ||
      t.room.toLowerCase().includes(q) ||
      t.description.toLowerCase().includes(q)
    );
  });
});

const totalTasks = allTasks.length;
const inProgressCount = allTasks.filter(
  (t) => t.status === "in_progress"
).length;
const doneCount = allTasks.filter((t) => t.status === "done").length;

const statusShort = (status: TaskStatus) => {
  switch (status) {
    case "in_progress":
      return "กำลังทำ";
    case "done":
      return "เสร็จแล้ว";
  }
};

const thaiMonthsShort = [
  "ม.ค.",
  "ก.พ.",
  "มี.ค.",
  "เม.ย.",
  "พ.ค.",
  "มิ.ย.",
  "ก.ค.",
  "ส.ค.",
  "ก.ย.",
  "ต.ค.",
  "พ.ย.",
  "ธ.ค.",
];

const formatUpdatedAt = (isoString: string) => {
  const date = new Date(isoString);
  const now = new Date();

  const diffMs = now.getTime() - date.getTime();
  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

  const hours = date.getHours().toString().padStart(2, "0");
  const minutes = date.getMinutes().toString().padStart(2, "0");
  const timePart = `${hours}:${minutes}`;

  if (diffDays === 0) {
    return `วันนี้ · ${timePart}`;
  }
  if (diffDays === 1) {
    return `เมื่อวาน · ${timePart}`;
  }
  if (diffDays <= 7) {
    return `${diffDays} วันก่อน · ${timePart}`;
  }

  const d = date.getDate().toString().padStart(2, "0");
  const m = thaiMonthsShort[date.getMonth()];
  const buddhistYear = date.getFullYear() + 543;

  return `${d} ${m} ${buddhistYear} ${timePart}`;
};

const formatDueDate = (isoString: string) => {
  const date = new Date(isoString);

  const d = date.getDate().toString().padStart(2, "0");
  const m = thaiMonthsShort[date.getMonth()];
  const buddhistYear = date.getFullYear() + 543;

  const hours = date.getHours().toString().padStart(2, "0");
  const minutes = date.getMinutes().toString().padStart(2, "0");

  return `${d} ${m} ${buddhistYear} ${hours}:${minutes} น.`;
};

/** พื้นหลังสุด (โทน pastel) เปลี่ยนตามตัวกรอง */
const pageBgClass = computed(() => {
  switch (selectedFilter.value) {
    // case "all":
    //   return "bg-blue-50";
    // case "in_progress":
    //   return "bg-amber-50";
    // case "done":
    //   return "bg-emerald-50";
    default:
      return "bg-slate-50";
  }
});
</script>
