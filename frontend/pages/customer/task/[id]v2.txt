<!-- pages/task/[id].vue -->
<template>
  <div class="min-h-screen bg-slate-50 pb-6">
    <header class="bg-slate-50/80 backdrop-blur">
      <!-- ‡πÅ‡∏ñ‡∏ß‡∏ö‡∏ô: ‡∏õ‡∏∏‡πà‡∏° back + ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤ + ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡∏á‡∏≤‡∏ô -->
      <div class="flex items-center justify-between px-4 pt-3 pb-2">
        <div class="flex items-center gap-3">
          <button
            type="button"
            class="flex h-8 w-8 items-center justify-center rounded-full bg-white shadow-sm"
            @click="goBack"
          >
            <ArrowLeft class="h-4 w-4 text-slate-700" />
          </button>

          <span class="text-[15px] font-semibold text-slate-900">
            ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô
          </span>
        </div>

        <!-- ‡∏ä‡∏¥‡∏õ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏á‡∏≤‡∏ô -->
        <span class="px-2.5 py-0.5 text-[11px] font-medium text-slate-600">
          {{ task.id }}
        </span>
      </div>

      <!-- ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô -->
      <TaskDetailHeader :task="task" />
    </header>

    <!-- üìù ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô (‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á header ‡∏Å‡∏±‡∏ö rating) -->
    <TaskSummaryCard :summary-saved="summarySaved" @click="openSummaryModal" />

    <!-- ‚≠ê ‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á header ‡∏Å‡∏±‡∏ö main -->
    <TaskSatisfactionCard
      :can-rate-this-task="canRateThisTask"
      :has-rated-this-task="hasRatedThisTask"
      :average-rating="averageRating"
      :loading="ratingLoading"
      @click="openRatingModal"
    />

    <main class="mt-1 space-y-4 px-4">
      <!-- ‡∏™‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô: ‡∏£‡∏π‡∏õ / ‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ -->
      <section
        v-if="task.media && task.media.length"
        class="rounded-2xl bg-white p-3.5 shadow-sm"
      >
        <div class="mb-2 flex items-center justify-between">
          <div
            class="inline-flex items-center gap-2 text-[13px] font-semibold text-slate-900"
          >
            <ImageIcon class="h-4 w-4 text-sky-500" />
            <span>‡∏™‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô</span>
          </div>
          <span class="text-[11px] text-slate-400">
            {{ task.media.length }} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
          </span>
        </div>

        <div class="flex gap-2 overflow-x-auto pb-1">
          <button
            v-for="(item, index) in task.media"
            :key="index"
            type="button"
            class="relative h-32 min-w-[140px] overflow-hidden rounded-2xl bg-slate-100 focus:outline-none"
            @click="openPreview(item)"
          >
            <!-- ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û -->
            <img
              v-if="item.type === 'image'"
              :src="item.url"
              :alt="`‡∏£‡∏π‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô ${index + 1}`"
              class="h-full w-full cursor-zoom-in object-cover"
            />

            <!-- ‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ -->
            <video
              v-else
              :src="item.url"
              class="h-full w-full object-cover"
              muted
              playsinline
            ></video>

            <!-- badge ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏∑‡πà‡∏≠ -->
            <span
              class="absolute bottom-1 right-1 rounded-full bg-black/60 px-1.5 py-0.5 text-[10px] font-medium text-white"
            >
              {{ item.type === "image" ? "‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û" : "‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠" }}
            </span>
          </button>
        </div>
      </section>

      <!-- ‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏•‡∏ô‡πå‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ -->
      <section class="rounded-2xl bg-white p-3.5 shadow-sm">
        <div class="mb-3 flex items-center justify-between">
          <div
            class="inline-flex items-center gap-2 text-[13px] font-semibold text-slate-900"
          >
            <Clock class="h-4 w-4 text-emerald-600" />
            <span>‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏•‡∏ô‡πå‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>
          </div>
          <span class="text-[11px] text-slate-400">
            ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà {{ currentStep }} / 5
          </span>
        </div>

        <div class="relative">
          <!-- ‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏±‡πâ‡∏á -->
          <div
            class="pointer-events-none absolute left-[13px] top-3 bottom-3 w-[2px] bg-slate-200"
          ></div>

          <!-- ‡πÉ‡∏ä‡πâ stepsDisplay ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏á 5 ‚Üí 1 -->
          <div
            v-for="step in stepsDisplay"
            :key="step.key"
            class="relative flex gap-3 pb-4 last:pb-0"
          >
            <!-- ‡∏à‡∏∏‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ + ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå -->
            <div
              class="relative mt-1 flex h-7 w-7 items-center justify-center rounded-full border-2 bg-white"
              :class="bulletClass(step.number)"
            >
              <!-- ‡∏£‡∏π‡∏õ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏Å -->
              <img
                :src="step.icon"
                :alt="step.label"
                class="h-4 w-4 object-contain"
              />

              <!-- ‡∏ï‡∏¥‡πä‡∏Å‡∏ñ‡∏π‡∏Å‡∏ã‡πâ‡∏≠‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß -->
              <div
                v-if="step.number < currentStep"
                class="absolute -bottom-0.5 -right-0.5 flex h-3.5 w-3.5 items-center justify-center rounded-full bg-emerald-500 shadow-sm"
              >
                <Check class="h-2.5 w-2.5 text-white" />
              </div>
            </div>

            <!-- ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° -->
            <div
              class="flex-1 rounded-2xl px-3 py-2.5 text-left"
              :class="cardClass(step.number)"
            >
              <p
                v-if="step.number === currentStep"
                class="mb-0.5 text-[11px] font-medium uppercase tracking-[0.18em] text-indigo-500"
              >
                ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
              </p>
              <p class="text-[13px] font-semibold text-slate-900">
                {{ step.label }}
              </p>
              <p
                v-if="stepDescription(step.number)"
                class="mt-0.5 text-[11px] leading-snug text-slate-500 whitespace-pre-line"
              >
                {{ stepDescription(step.number) }}
              </p>

              <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏π‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ä‡πà‡∏≤‡∏á ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏±‡πâ‡∏ô on_the_way -->
              <div
                v-if="step.key === 'on_the_way'"
                class="mt-2 flex items-center justify-between"
              >
                <p class="text-[10px] text-slate-500">
                  ‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏ä‡πà‡∏≤‡∏á‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
                </p>
                <button
                  type="button"
                  class="inline-flex items-center gap-1 rounded-full bg-emerald-500 px-2.5 py-1 text-[11px] font-medium text-white shadow-sm active:scale-95"
                  @click.stop="openStaffLocationModal"
                >
                  <MapPin class="h-3.5 w-3.5 text-white" />
                  <span>‡∏î‡∏π‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- ‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô -->
      <section class="rounded-2xl bg-white p-3.5 shadow-sm">
        <div class="mb-3 flex items-center justify-between">
          <div
            class="inline-flex items-center gap-2 text-[13px] font-semibold text-slate-900"
          >
            <MessageCircle class="h-4 w-4 text-indigo-500" />
            <span>‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô</span>
          </div>
          <span class="text-[11px] text-slate-400">
            {{ commentCount }} ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡πá‡∏ô
          </span>
        </div>

        <!-- ‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡πÉ‡∏´‡∏°‡πà -->
        <div class="flex gap-3">
          <!-- mock avatar -->
          <div
            class="mt-1 flex h-9 w-9 items-center justify-center rounded-full bg-indigo-100 text-[11px] font-semibold text-indigo-700"
          >
            ‡∏ä‡πà‡∏≤‡∏á
          </div>

          <div class="flex-1">
            <textarea
              v-model="newCommentText"
              rows="2"
              class="w-full rounded-2xl border border-slate-200 bg-slate-50 px-3 py-2 text-[12px] text-slate-900 placeholder:text-slate-400 focus:border-indigo-400 focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-100"
              placeholder="‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏ñ‡∏∂‡∏á‡∏•‡∏π‡∏Å‡∏ö‡πâ‡∏≤‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô..."
            ></textarea>

            <!-- preview media ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å -->
            <div
              v-if="newCommentMedia.length"
              class="mt-2 flex gap-2 overflow-x-auto"
            >
              <div
                v-for="(m, index) in newCommentMedia"
                :key="index"
                class="relative h-16 w-20 overflow-hidden rounded-xl bg-slate-100"
              >
                <img
                  v-if="m.type === 'image'"
                  :src="m.url"
                  class="h-full w-full object-cover"
                />
                <video
                  v-else
                  :src="m.url"
                  class="h-full w-full object-cover"
                  muted
                  playsinline
                ></video>

                <button
                  type="button"
                  class="absolute right-1 top-1 flex h-5 w-5 items-center justify-center rounded-full bg-black/60 text-[10px] text-white"
                  @click="removeNewCommentMedia(index)"
                >
                  <X class="h-3 w-3" />
                </button>
              </div>
            </div>

            <div class="mt-2 flex items-center justify-between">
              <div class="flex items-center gap-1.5">
                <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ -->
                <label
                  class="flex h-8 w-8 cursor-pointer items-center justify-center rounded-full border border-slate-200 bg-slate-50 text-slate-500 hover:bg-slate-100"
                >
                  <ImageIcon class="h-4 w-4" />
                  <input
                    type="file"
                    class="hidden"
                    multiple
                    accept="image/*"
                    @change="handleNewCommentFiles($event, 'image')"
                  />
                </label>

                <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ô‡∏ö‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ -->
                <label
                  class="flex h-8 w-8 cursor-pointer items-center justify-center rounded-full border border-slate-200 bg-slate-50 text-slate-500 hover:bg-slate-100"
                >
                  <Video class="h-4 w-4" />
                  <input
                    type="file"
                    class="hidden"
                    multiple
                    accept="video/*"
                    @change="handleNewCommentFiles($event, 'video')"
                  />
                </label>
              </div>

              <button
                type="button"
                class="inline-flex items-center gap-1 rounded-full bg-indigo-600 px-3 py-1.5 text-[11px] font-medium text-white shadow-sm disabled:cursor-not-allowed disabled:bg-slate-300"
                :disabled="!canSubmitComment"
                @click="submitComment"
              >
                <Send class="h-3.5 w-3.5" />
                <span>‡∏™‡πà‡∏á‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå</span>
              </button>
            </div>
          </div>
        </div>

        <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå -->
        <div
          v-if="commentsForTask.length"
          class="mt-4 border-t border-slate-100 pt-3 space-y-3"
        >
          <article
            v-for="comment in commentsForTask"
            :key="comment.id"
            class="flex gap-3"
          >
            <!-- avatar ‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏ä‡∏∑‡πà‡∏≠ -->
            <div
              class="mt-0.5 flex h-8 w-8 items-center justify-center rounded-full text-[11px] font-semibold"
              :class="
                comment.role === 'operator'
                  ? 'bg-indigo-100 text-indigo-700'
                  : 'bg-amber-100 text-amber-700'
              "
            >
              {{ getInitials(comment.author) }}
            </div>

            <div
              class="flex-1 rounded-2xl border border-slate-100 bg-slate-50 px-3 py-2.5"
            >
              <div class="flex items-center justify-between gap-2">
                <div class="flex items-center gap-1.5">
                  <p class="text-[12px] font-semibold text-slate-900">
                    {{ comment.author }}
                  </p>
                  <span
                    v-if="comment.role === 'operator'"
                    class="rounded-full bg-indigo-50 px-2 py-[2px] text-[10px] font-medium text-indigo-600"
                  >
                    ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà
                  </span>
                  <span
                    v-else
                    class="rounded-full bg-amber-50 px-2 py-[2px] text-[10px] font-medium text-amber-700"
                  >
                    ‡∏•‡∏π‡∏Å‡∏ö‡πâ‡∏≤‡∏ô
                  </span>
                </div>

                <span class="text-[10px] text-slate-400">
                  {{ formatCommentTime(comment.createdAt) }}
                </span>
              </div>

              <p
                v-if="comment.message"
                class="mt-1 text-[12px] leading-snug text-slate-800 whitespace-pre-line"
              >
                {{ comment.message }}
              </p>

              <div
                v-if="comment.media && comment.media.length"
                class="mt-2 flex flex-wrap gap-2"
              >
                <button
                  v-for="m in comment.media"
                  :key="m.id"
                  type="button"
                  class="relative h-16 w-20 overflow-hidden rounded-xl bg-slate-100"
                  @click="openPreview(m)"
                >
                  <img
                    v-if="m.type === 'image'"
                    :src="m.url"
                    class="h-full w-full object-cover"
                  />
                  <video
                    v-else
                    :src="m.url"
                    class="h-full w-full object-cover"
                    muted
                    playsinline
                  ></video>

                  <span
                    class="absolute bottom-1 right-1 rounded-full bg-black/60 px-1.5 py-0.5 text-[9px] font-medium text-white"
                  >
                    {{ m.type === "image" ? "‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û" : "‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠" }}
                  </span>
                </button>
              </div>
            </div>
          </article>
        </div>

        <!-- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå -->
        <p v-else class="mt-3 text-center text-[11px] text-slate-400">
          ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ
        </p>
      </section>
    </main>

    <!-- üó∫ STAFF LOCATION MAP MODAL (Google Maps JS API) -->
    <div
      v-if="staffLocationModalOpen"
      class="fixed inset-0 z-50 flex items-end justify-center bg-black/50 sm:items-center"
      @click.self="closeStaffLocationModal"
    >
      <div
        class="h-[70vh] w-full max-w-md rounded-t-3xl bg-white shadow-lg sm:h-[70vh] sm:rounded-2xl"
      >
        <!-- header -->
        <div class="flex items-center justify-between px-4 pt-3 pb-2">
          <div class="flex items-center gap-2">
            <div
              class="flex h-8 w-8 items-center justify-center rounded-full bg-emerald-50"
            >
              <MapPin class="h-4 w-4 text-emerald-600" />
            </div>
            <div>
              <p class="text-[13px] font-semibold text-slate-900">
                ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ä‡πà‡∏≤‡∏á (‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå)
              </p>
              <p class="text-[10px] text-slate-500">
                {{ staffLocationTimeLabel }}
              </p>
            </div>
          </div>

          <button
            type="button"
            class="flex h-8 w-8 items-center justify-center rounded-full bg-slate-100 text-slate-500"
            @click="closeStaffLocationModal"
          >
            <X class="h-4 w-4" />
          </button>
        </div>

        <div class="h-[1px] bg-slate-100"></div>

        <!-- container ‡∏Ç‡∏≠‡∏á Google Map -->
        <div class="h-[calc(100%-49px)] w-full">
          <div ref="mapContainer" class="h-full w-full"></div>
        </div>
      </div>
    </div>

    <!-- Rating Modal -->
    <TaskRatingFlow
      v-model:open="ratingModalOpen"
      v-model:success-open="ratingSuccessModalOpen"
      :rating-loading="ratingLoading"
      :has-rated-this-task="hasRatedThisTask"
      :can-submit-rating="canSubmitRating"
      :rating-items="ratingItems"
      :temp-rating-scores="tempRatingScores"
      :set-temp-score="setTempScore"
      :submit-rating="submitRating"
      :close-rating-modal="closeRatingModal"
    />

    <!-- üìù SUMMARY MODAL -->
    <ModalBottom v-model="summaryModalOpen">
      <TaskSummaryDialog
        :summaryLoading="summaryLoading"
        :summarySaved="summarySaved"
        :canSubmitSummary="canSubmitSummary"
        :workSummary="workSummary"
        :saveWorkSummary="saveWorkSummary"
        :closeSummaryModal="closeSummaryModal"
        :formatSummaryDateTime="formatSummaryDateTime"
      />
    </ModalBottom>

    <!-- ‚úÖ SUMMARY SUCCESS MODAL -->

    <ModalBottom v-model="summarySuccessModalOpen">
      <BaseStatusModal
        variant="success"
        title="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"
        message="‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß"
        button-text="‡∏õ‡∏¥‡∏î"
        @close="summarySuccessModalOpen = false"
      />
    </ModalBottom>

    <!-- FULLSCREEN MEDIA PREVIEW -->
    <div
      v-if="previewOpen && previewMedia"
      class="fixed inset-0 z-40 flex items-center justify-center bg-black/80"
      @click.self="closePreview"
    >
      <button
        type="button"
        class="absolute right-4 top-4 flex h-9 w-9 items-center justify-center rounded-full bg-black/60 text-white shadow-lg"
        @click="closePreview"
      >
        <X class="h-5 w-5" />
      </button>

      <img
        v-if="previewMedia.type === 'image'"
        :src="previewMedia.url"
        alt="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô"
        class="max-h-[90vh] max-w-[100vw] object-contain"
      />
      <video
        v-else
        :src="previewMedia.url"
        controls
        autoplay
        class="max-h-[90vh] max-w-[100vw]"
      ></video>
    </div>
  </div>
</template>

<script setup lang="ts">
import { computed, ref, watch, nextTick } from "vue";
import { useRoute, useRouter } from "vue-router";
import {
  ArrowLeft,
  MapPin,
  Clock,
  Image as ImageIcon,
  X,
  Check,
  MessageCircle,
  Send,
  Video,
} from "lucide-vue-next";
import TaskDetailHeader from "@/components/share/task/detail/TaskDetailHeader.vue";
import TaskSummaryCard from "@/components/employee/task/TaskSummaryCard.vue";
import TaskSatisfactionCard from "@/components/customer/task/TaskSatisfactionCard.vue";
import TaskRatingDialog from "@/components/customer/task/rating/TaskRatingDialog.vue";
import TaskSummaryDialog from "@/components/employee/task/TaskSummaryDialog.vue";
import ModalBottom from "@/components/share/ModalBottom.vue";
import BaseStatusModal from "@/components/share/status/BaseStatusModal.vue";
import ResponsiveModal from "@/components/share/ResponsiveModal.vue";
import { useRatingFlow } from "@/composables/task/customer/rating/useRatingFlow";
import TaskRatingFlow from "@/components/customer/task/rating/TaskRatingFlow.vue";

definePageMeta({
  layout: "blank",
});

// setPageLayout(isMobile.value ? "blank" : "default");

// ‡∏ö‡∏≠‡∏Å TS ‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ google ‡∏°‡∏≤‡∏à‡∏≤‡∏Å script ‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å
declare const google: any;

type TaskStatus = "in_progress" | "done";
type MediaType = "image" | "video";

interface TaskMedia {
  type: MediaType;
  url: string;
}

interface StepRuntimeInfo {
  step: number;
  finishedAt?: string;
  dueAt?: string;
  operator?: string;
}

interface TimelineStep {
  key: string;
  label: string;
  description?: string;
  number: number;
  icon: string; // ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å online
}

interface TaskDetail {
  id: string;
  room: string;
  description: string;
  status: TaskStatus;
  updatedAt: string;
  media: TaskMedia[];
  currentStep: number;
  timeline?: StepRuntimeInfo[];
}

/* ---------- comment types ---------- */

interface CommentMedia extends TaskMedia {
  id: string;
}

interface TaskComment {
  id: string;
  taskId: string;
  author: string;
  role: "customer" | "operator";
  createdAt: string;
  message: string;
  media: CommentMedia[];
}

/* ---------------- base steps + online icons ---------------- */

const baseSteps: Omit<TimelineStep, "number">[] = [
  {
    key: "received",
    label: "‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á",
    description: "‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß",
    icon: "https://img.icons8.com/color/48/inbox.png",
  },
  {
    key: "prepare",
    label: "‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç",
    description: "‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÅ‡∏•‡∏∞‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô",
    icon: "https://img.icons8.com/color/48/maintenance.png",
  },
  {
    key: "on_the_way",
    label: "‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á",
    description: "‡∏ä‡πà‡∏≤‡∏á‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤",
    icon: "https://img.icons8.com/color/48/road.png",
  },
  {
    key: "fixing",
    label: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç",
    description: "‡∏ä‡πà‡∏≤‡∏á‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô",
    icon: "https://img.icons8.com/color/48/service.png",
  },
  {
    key: "done",
    label: "‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß",
    description: "‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏î‡πâ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤",
    icon: "https://img.icons8.com/color/48/checkmark--v1.png",
  },
];

const steps: TimelineStep[] = baseSteps.map((s, idx) => ({
  ...s,
  number: idx + 1,
}));

const stepsDisplay = computed(() => [...steps].reverse());

/* ---------------- mock data ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ---------------- */

const allTasks: TaskDetail[] = [
  {
    id: "TSK-0001",
    room: "1205",
    description: "‡πÅ‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡πÄ‡∏¢‡πá‡∏ô ‡∏°‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏î‡∏±‡∏á‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏¢‡πá‡∏ô ‡∏Ç‡∏≠‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏ä‡πá‡∏Å‡∏î‡πà‡∏ß‡∏ô",
    status: "in_progress",
    updatedAt: "2025-11-13T09:24:00+07:00",
    currentStep: 4,
    media: [
      {
        type: "image",
        url: "https://images.pexels.com/photos/3768913/pexels-photo-3768913.jpeg",
      },
      {
        type: "image",
        url: "https://images.pexels.com/photos/3968102/pexels-photo-3968102.jpeg",
      },
      {
        type: "video",
        url: "https://www.w3schools.com/html/mov_bbb.mp4",
      },
    ],
    timeline: [
      {
        step: 1,
        finishedAt: "2025-11-10T10:12:26+07:00",
        operator: "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß ‡∏†‡∏±‡∏ó‡∏ò‡∏≤‡∏ß‡∏î‡∏µ ‡∏≠‡∏†‡∏¥‡∏ä‡∏¥‡∏£‡∏±‡∏ç‡πÇ‡∏ä‡∏ï‡∏¥",
      },
      {
        step: 2,
        finishedAt: "2025-11-10T10:18:04+07:00",
        operator: "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß ‡∏†‡∏±‡∏ó‡∏ò‡∏≤‡∏ß‡∏î‡∏µ ‡∏≠‡∏†‡∏¥‡∏ä‡∏¥‡∏£‡∏±‡∏ç‡πÇ‡∏ä‡∏ï‡∏¥",
      },
      {
        step: 3,
        finishedAt: "2025-11-12T08:35:46+07:00",
        operator: "‡∏ô‡∏≤‡∏¢ ‡∏™‡∏£‡∏ß‡∏¥‡∏ä‡∏ç‡πå ‡∏™‡∏°‡∏à‡∏¥‡∏ï‡∏£",
      },
      {
        step: 4,
        dueAt: "2025-11-30T00:00:00+07:00",
      },
      {
        step: 5,
        dueAt: "2025-12-01T00:00:00+07:00",
      },
    ],
  },
  {
    id: "TSK-0002",
    room: "803",
    description: "‡πÑ‡∏ü‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏£‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå",
    status: "in_progress",
    updatedAt: "2025-11-13T08:10:00+07:00",
    currentStep: 2,
    media: [
      {
        type: "image",
        url: "https://images.pexels.com/photos/4107014/pexels-photo-4107014.jpeg",
      },
    ],
  },
  {
    id: "TSK-0003",
    room: "1502",
    description: "‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏á‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡πà‡∏™‡∏ô‡∏¥‡∏ó ‡∏°‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏°‡πÅ‡∏£‡∏á‡∏ï‡∏≠‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô",
    status: "in_progress",
    updatedAt: "2025-11-12T15:32:00+07:00",
    currentStep: 3,
    media: [
      {
        type: "video",
        url: "https://www.w3schools.com/html/mov_bbb.mp4",
      },
    ],
  },
  {
    id: "TSK-0004",
    room: "607",
    description: "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏µ‡πÇ‡∏°‡∏ï‡∏ó‡∏µ‡∏ß‡∏µ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏≥‡∏ï‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ",
    status: "done",
    updatedAt: "2025-11-12T10:18:00+07:00",
    currentStep: 5,
    media: [],
  },
  {
    id: "TSK-0005",
    room: "302",
    description: "‡∏ù‡∏±‡∏Å‡∏ö‡∏±‡∏ß‡∏£‡∏±‡πà‡∏ß ‡∏ô‡πâ‡∏≥‡∏Å‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡πÇ‡∏ã‡∏ô‡∏≠‡∏≤‡∏ö‡∏ô‡πâ‡∏≥",
    status: "in_progress",
    updatedAt: "2025-11-11T18:42:00+07:00",
    currentStep: 1,
    media: [],
  },
];

/* -------- mock comments (‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå) -------- */

const allComments = ref<TaskComment[]>([
  {
    id: "CMT-0001",
    taskId: "TSK-0001",
    author: "‡∏•‡∏π‡∏Å‡∏ö‡πâ‡∏≤‡∏ô 1205",
    role: "customer",
    createdAt: "2025-11-13T09:15:00+07:00",
    message:
      "‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏≠‡∏£‡πå‡∏°‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏î‡∏±‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏î‡∏π‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ä‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏ô‡∏∞‡∏Ñ‡∏∞",
    media: [
      {
        id: "CMT-0001-M1",
        type: "video",
        url: "https://www.w3schools.com/html/mov_bbb.mp4",
      },
    ],
  },
  {
    id: "CMT-0002",
    taskId: "TSK-0001",
    author: "‡∏ô‡∏≤‡∏¢ ‡∏™‡∏£‡∏ß‡∏¥‡∏ä‡∏ç‡πå ‡∏™‡∏°‡∏à‡∏¥‡∏ï‡∏£",
    role: "operator",
    createdAt: "2025-11-13T09:20:00+07:00",
    message:
      "‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ä‡πà‡∏≤‡∏á‡∏à‡∏∞‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 10:30 ‡∏ô. ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÇ‡∏ó‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏•‡∏π‡∏Å‡∏ö‡πâ‡∏≤‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏±‡∏ö",
    media: [],
  },
  {
    id: "CMT-0003",
    taskId: "TSK-0002",
    author: "‡∏•‡∏π‡∏Å‡∏ö‡πâ‡∏≤‡∏ô 803",
    role: "customer",
    createdAt: "2025-11-13T08:05:00+07:00",
    message: "‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏ï‡∏π‡πâ‡πÑ‡∏ü‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏±‡∏ö ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏ö‡∏£‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡∏à‡∏∞‡∏ï‡∏Å‡∏≠‡∏¢‡∏π‡πà",
    media: [
      {
        id: "CMT-0003-M1",
        type: "image",
        url: "https://images.pexels.com/photos/4107014/pexels-photo-4107014.jpeg",
      },
    ],
  },
]);

/* ---------------- logic ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ---------------- */

const route = useRoute();
const router = useRouter();

const taskId = computed(() => route.params.id as string);

const task = computed(() => {
  const found = allTasks.find((t) => t.id === taskId.value);
  return found || allTasks[0];
});

const currentStep = computed(() => task.value.currentStep);

const thaiMonthsShort = [
  "‡∏°.‡∏Ñ.",
  "‡∏Å.‡∏û.",
  "‡∏°‡∏µ.‡∏Ñ.",
  "‡πÄ‡∏°.‡∏¢.",
  "‡∏û.‡∏Ñ.",
  "‡∏°‡∏¥.‡∏¢.",
  "‡∏Å.‡∏Ñ.",
  "‡∏™.‡∏Ñ.",
  "‡∏Å.‡∏¢.",
  "‡∏ï.‡∏Ñ.",
  "‡∏û.‡∏¢.",
  "‡∏ò.‡∏Ñ.",
];

const formatThaiDate = (isoString: string) => {
  const date = new Date(isoString);
  const d = date.getDate().toString().padStart(2, "0");
  const m = thaiMonthsShort[date.getMonth()];
  const y = date.getFullYear() + 543;
  return `${d} ${m} ${y}`;
};

const formatThaiDateTime = (isoString: string) => {
  const date = new Date(isoString);
  const datePart = formatThaiDate(isoString);
  const hh = date.getHours().toString().padStart(2, "0");
  const mm = date.getMinutes().toString().padStart(2, "0");
  const ss = date.getSeconds().toString().padStart(2, "0");
  return `${datePart} ${hh}:${mm}:${ss}`;
};

const formatUpdatedAt = (isoString: string) => {
  const date = new Date(isoString);
  const now = new Date();

  const diffMs = now.getTime() - date.getTime();
  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

  const hours = date.getHours().toString().padStart(2, "0");
  const minutes = date.getMinutes().toString().padStart(2, "0");
  const timePart = `${hours}:${minutes}`;

  if (diffDays === 0) return `‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ¬∑ ${timePart}`;
  if (diffDays === 1) return `‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô ¬∑ ${timePart}`;
  if (diffDays <= 7) return `${diffDays} ‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô ¬∑ ${timePart}`;

  const d = date.getDate().toString().padStart(2, "0");
  const m = thaiMonthsShort[date.getMonth()];
  const buddhistYear = date.getFullYear() + 543;
  return `${d} ${m} ${buddhistYear} ${timePart}`;
};

const updatedLabel = computed(() => formatUpdatedAt(task.value.updatedAt));

const stepRuntimeMap = computed(() => {
  const map = new Map<number, StepRuntimeInfo>();
  (task.value.timeline || []).forEach((info) => {
    map.set(info.step, info);
  });
  return map;
});

const getDefaultStepDescription = (stepNumber: number) => {
  const s = steps.find((st) => st.number === stepNumber);
  return s?.description || "";
};

const stepDescription = (stepNumber: number) => {
  const info = stepRuntimeMap.value.get(stepNumber);
  if (info) {
    if (info.finishedAt) {
      const opLine = info.operator ? `\n‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô ${info.operator}` : "";
      return `‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏™‡∏£‡πá‡∏à ${formatThaiDateTime(
        info.finishedAt
      )}${opLine}`;
    }
    if (info.dueAt) {
      return `‡∏ß‡∏±‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏™‡∏£‡πá‡∏à ${formatThaiDate(info.dueAt)}`;
    }
  }
  return getDefaultStepDescription(stepNumber);
};

const bulletClass = (stepNumber: number) => {
  if (stepNumber < currentStep.value) {
    return "border-emerald-500 bg-emerald-50";
  }
  if (stepNumber === currentStep.value) {
    return "bg-indigo-50 border border-indigo-200 shadow-sm";
  }
  return "border-slate-200 bg-slate-50 opacity-80";
};

const cardClass = (stepNumber: number) => {
  if (stepNumber < currentStep.value) {
    return "bg-emerald-50 border border-emerald-100";
  }
  if (stepNumber === currentStep.value) {
    return "bg-indigo-50 border border-indigo-100";
  }
  return "bg-slate-50 border border-slate-100 opacity-90";
};


interface PreviewMedia {
  type: MediaType;
  url: string;
}

const previewOpen = ref(false);
const previewMedia = ref<PreviewMedia | null>(null);

const openPreview = (media: TaskMedia | CommentMedia) => {
  previewMedia.value = { type: media.type, url: media.url };
  previewOpen.value = true;
};

const closePreview = () => {
  previewOpen.value = false;
  previewMedia.value = null;
};

const goBack = () => {
  router.back();
};

/* --------- comments computed & helpers --------- */

const commentsForTask = computed(() =>
  allComments.value.filter((c) => c.taskId === task.value.id)
);

const commentCount = computed(() => commentsForTask.value.length);

const formatCommentTime = (isoString: string) => {
  return formatUpdatedAt(isoString);
};

const getInitials = (name: string) => {
  const parts = name.trim().split(" ").filter(Boolean);
  if (!parts.length) return "?";
  if (parts.length === 1) return parts[0].slice(0, 2);
  return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
};

/* --------- new comment state & actions --------- */

interface NewCommentMedia {
  type: MediaType;
  url: string;
}

const newCommentText = ref("");
const newCommentMedia = ref<NewCommentMedia[]>([]);

const handleNewCommentFiles = (event: Event, type: MediaType) => {
  const target = event.target as HTMLInputElement;
  if (!target.files?.length) return;

  Array.from(target.files).forEach((file) => {
    const url = URL.createObjectURL(file);
    newCommentMedia.value.push({ type, url });
  });

  target.value = "";
};

const removeNewCommentMedia = (index: number) => {
  newCommentMedia.value.splice(index, 1);
};

const canSubmitComment = computed(
  () =>
    newCommentText.value.trim().length > 0 || newCommentMedia.value.length > 0
);

const submitComment = () => {
  if (!canSubmitComment.value) return;

  const nowIso = new Date().toISOString();
  const baseId = Date.now();

  const newItem: TaskComment = {
    id: `CMT-${baseId}`,
    taskId: task.value.id,
    author: "‡∏ä‡πà‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á",
    role: "operator",
    createdAt: nowIso,
    message: newCommentText.value.trim(),
    media: newCommentMedia.value.map((m, index) => ({
      id: `CMT-${baseId}-M${index + 1}`,
      type: m.type,
      url: m.url,
    })),
  };

  allComments.value = [newItem, ...allComments.value];

  newCommentText.value = "";
  newCommentMedia.value = [];
};

/* ---------- rating config ---------- */

interface RatingItem {
  id: string;
  label: string;
}

// const taskRatings = ref<Record<string, number[]>>({
//   "TSK-0004": [5, 5, 4, 5, 4, 5],
// });

/* ---------- rating modal state ---------- */

const {
  ratingModalOpen,
  ratingSuccessModalOpen,
  ratingLoading,

  ratingItems,
  tempRatingScores,

  canRateThisTask,
  currentRatingScores,
  hasRatedThisTask,
  averageRating,
  canSubmitRating,

  setTempScore,
  openRatingModal,
  closeRatingModal,
  submitRating,
} = useRatingFlow(task);

/* ---------- ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ä‡πà‡∏≤‡∏á + Google Maps JS API ---------- */

interface StaffLocation {
  lat: number;
  lng: number;
  updatedAt: string;
}

const staffLocation = ref<StaffLocation>({
  lat: 13.7563,
  lng: 100.5018,
  updatedAt: new Date().toISOString(),
});

const staffLocationModalOpen = ref(false);

const openStaffLocationModal = () => {
  staffLocationModalOpen.value = true;
};

const closeStaffLocationModal = () => {
  staffLocationModalOpen.value = false;

  // reset map ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô
  if (staffMarker.value) {
    staffMarker.value.setMap(null);
    staffMarker.value = null;
  }
  if (mapInstance.value) {
    mapInstance.value = null;
  }
};

const staffLocationTimeLabel = computed(
  () => `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ${formatUpdatedAt(staffLocation.value.updatedAt)}`
);

const mapContainer = ref<HTMLDivElement | null>(null);
const mapInstance = ref<any>(null);
const staffMarker = ref<any>(null);

let googleMapsLoading: Promise<void> | null = null;

const loadGoogleMaps = (): Promise<void> => {
  if (typeof window === "undefined") return Promise.resolve();

  const g = (window as any).google;
  if (g && g.maps) {
    return Promise.resolve();
  }

  if (!googleMapsLoading) {
    googleMapsLoading = new Promise((resolve, reject) => {
      const script = document.createElement("script");
      script.src =
        "https://maps.googleapis.com/maps/api/js?key=AIzaSyAgf48aWg9fr48mzGvoJqKSsNINYzBhdRQ&callback=initMap&language=th&region=TH";
      script.async = true;
      script.defer = true;
      script.onload = () => resolve();
      script.onerror = () =>
        reject(new Error("Google Maps JavaScript API failed to load"));
      document.head.appendChild(script);
    });
  }

  return googleMapsLoading;
};

const initMap = async () => {
  if (!mapContainer.value) return;

  await loadGoogleMaps();

  const g = (window as any).google;
  if (!g || !g.maps) return;

  const { lat, lng } = staffLocation.value;

  if (!mapInstance.value) {
    mapInstance.value = new g.maps.Map(mapContainer.value, {
      center: { lat, lng },
      zoom: 17,
      disableDefaultUI: false,
      gestureHandling: "greedy",
    });

    staffMarker.value = new g.maps.Marker({
      position: { lat, lng },
      map: mapInstance.value,
      title: "‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ä‡πà‡∏≤‡∏á",
    });
  } else {
    mapInstance.value.setCenter({ lat, lng });
    if (staffMarker.value) {
      staffMarker.value.setPosition({ lat, lng });
    }
  }
};

watch(staffLocationModalOpen, async (open) => {
  if (open) {
    await nextTick();
    await initMap();
  }
});

watch(
  staffLocation,
  (loc) => {
    if (!mapInstance.value || !staffMarker.value || !loc) return;
    const pos = { lat: loc.lat, lng: loc.lng };
    staffMarker.value.setPosition(pos);
    mapInstance.value.setCenter(pos);
  },
  { deep: true }
);

/* ---------- ‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô (Summary) ---------- */

const summaryModalOpen = ref(false);
const summarySuccessModalOpen = ref(false);
const summarySaved = ref(false);
const summaryLoading = ref(false);

const workSummary = ref({
  startTime: "",
  endTime: "",
  process: "",
  pending: "",
});

const openSummaryModal = () => {
  summaryModalOpen.value = true;
};

const closeSummaryModal = () => {
  if (summaryLoading.value) return; // ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏´‡πâ‡∏≤‡∏°‡∏õ‡∏¥‡∏î
  summaryModalOpen.value = false;
};
const onSummaryBackdropClick = () => {
  if (summaryLoading.value) return;
  closeSummaryModal();
};

const canSubmitSummary = computed(() => {
  return (
    !!workSummary.value.startTime &&
    !!workSummary.value.endTime &&
    workSummary.value.process.trim().length > 0
  );
});

const saveWorkSummary = async () => {
  if (!canSubmitSummary.value || summarySaved.value || summaryLoading.value)
    return;

  summaryLoading.value = true;
  try {
    // üëá ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
    // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏à‡∏≥‡∏•‡∏≠‡∏á request ‡∏ä‡πâ‡∏≤
    await new Promise((resolve) => setTimeout(resolve, 1500));

    // ‡∏ñ‡πâ‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
    summarySaved.value = true;
    summaryModalOpen.value = false;
    summarySuccessModalOpen.value = true;
  } catch (error) {
    console.error("saveWorkSummary error:", error);
    // ‡∏à‡∏∞‡πÉ‡∏™‡πà toast / alert ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Å‡πá‡πÑ‡∏î‡πâ
  } finally {
    summaryLoading.value = false;
  }
};

const formatSummaryDateTime = (value: string) => {
  if (!value) return "";
  // value ‡∏à‡∏≤‡∏Å datetime-local ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô "2025-11-17T09:30"
  const date = new Date(value);
  if (Number.isNaN(date.getTime())) return value;

  const d = date.getDate().toString().padStart(2, "0");
  const m = thaiMonthsShort[date.getMonth()];
  const y = date.getFullYear() + 543;
  const hh = date.getHours().toString().padStart(2, "0");
  const mm = date.getMinutes().toString().padStart(2, "0");
  return `${d} ${m} ${y} ${hh}:${mm} ‡∏ô.`;
};
</script>

<style scoped></style>
